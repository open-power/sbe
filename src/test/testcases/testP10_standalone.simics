#!/bin/sh
# IBM_PROLOG_BEGIN_TAG
# This is an automatically generated prolog.
#
# $Source: src/test/testcases/testP10_standalone.simics $
#
# OpenPOWER sbe Project
#
# Contributors Listed Below - COPYRIGHT 2018,2021
# [+] International Business Machines Corp.
#
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
# implied. See the License for the specific language governing
# permissions and limitations under the License.
#
# IBM_PROLOG_END_TAG

$procNr = -1
foreach $proc in (get-component-list -all proc_p10) {

    $procNr = $procNr + 1
    echo "**************** Run sbe testcases for " + $proc + "****************"
    $proc.pib_cmp.pib_psu->tppsu_tpbr_interrupt_msg_available=[NIL]
    echo "Run-cycles"

    #sim->frontend_current_processor = backplane0.dcm[0].chip[0].pib_cmp.sbe_ppe
    #sim->frontend_current_processor
    #b 0xff880520

    #output-file-start pib_cmp_dump -overwrite
    #backplane0.dcm[0].chip[0].pib_cmp.cecchip.log-level 1
    # calebs
    #script-branch "wait for configuration loaded before starting" {
    #       wait-for-hap hap = Core_Configuration_Loaded
    #       echo "Post Core_Configuration_Loaded hap"
    #}

    run-cycles 10000000

    #run
    #run-seconds 1.0

    if $proc == backplane0.dcm[0].chip[0] {

        echo "*******************Run testRunTillSbeBooted.py************************"

        run-python-file targets/p10_standalone/sbeTest/testRunTillSbeBooted.py

        echo "*******************Run testIstepInvalidFenced.py*******************"

        run-python-file targets/p10_standalone/sbeTest/testIstepInvalidFenced.py

        echo "*******************Run testPSUSetStashPair.py*******************"

        run-python-file targets/p10_standalone/sbeTest/testPSUSetStashPair.py

    }

    #Enable slave proc. Master proc is already enblaed.
    if  $proc != backplane0.dcm[0].chip[0] {

        echo "*******************sbe-start-slaveProc.py************************"

        run-python-file targets/p10_standalone/sbeTest/sbe-start-slaveProc.py

        echo "*******************Run testRunTillSbeBootedSlaveProc.py****************"

        run-python-file targets/p10_standalone/sbeTest/testRunTillSbeBootedSlaveProc.py
    }

    echo "*******************Run SBE-ISTEPS ******************"

    sbe-istep 2.2 3.18 $procNr

    #backplane0.dcm[0].chip[0].pib_cmp.sbe_ppe.pregs
    #backplane0.dcm[0].chip[0].pib_cmp.cecchip.invoke parallel_load SCOM 0x1000100 64
    #backplane0.dcm[0].chip[0].pib_cmp.cecchip.invoke parallel_load SCOM 0x1030005 64
    #output-file-stop

    if $proc == backplane0.dcm[0].chip[0] {

        echo "*******************Run SBE-ISTEPS ******************"

        sbe-istep 3.19 5.1

        echo "*******************Run testMatchStashPair.py*******************"

        run-python-file targets/p10_standalone/sbeTest/testMatchStashPair.py

        sbe-istep 5.2 5.3

        echo "*******************Run testGetDump.py*******************"
        # TODO: Enable testGetDump.py along with all DUMP util scripts
        #run-python-file targets/p10_standalone/sbeTest/testGetDump.py

        echo "*******************Run testSram.py *******************"

        run-python-file targets/p10_standalone/sbeTest/testSram.py

        echo "**Run testIstepInvalid.py and testIstepInvalidFenced.py **"

        run-python-file targets/p10_standalone/sbeTest/testIstepInvalid.py

        run-python-file targets/p10_standalone/sbeTest/testIstepInvalidFenced.py

        echo "*******************Run testGetCapabilities.py******************"

        run-python-file targets/p10_standalone/sbeTest/testGetCapabilities.py

        echo "*******************Run testSbeDump.py******************"

        run-python-file targets/p10_standalone/sbeTest/testSbeDump.py

        echo "*******************Run testPSUGetCapabilities.py*******************"

        run-python-file targets/p10_standalone/sbeTest/testPSUGetCapabilities.py

        echo "*******************Run testSuspendIO.py*******************"

        run-python-file targets/p10_standalone/sbeTest/testSuspendIO.py

        echo "*******************Run testStopInstruction.py******************"

        run-python-file targets/p10_standalone/sbeTest/testStopInstruction.py

        echo "*******************Run testPutGetRegGpr.py*******************"

        run-python-file targets/p10_standalone/sbeTest/testPutGetRegGpr.py

        echo "*******************Run testPutGetRegFpr.py*******************"

        run-python-file targets/p10_standalone/sbeTest/testPutGetRegFpr.py

        echo "*******************Run testPutGetRegSpr.py*******************"

        run-python-file targets/p10_standalone/sbeTest/testPutGetRegSpr.py

        echo "*******************Run testStartInstruction.py******************"

        run-python-file targets/p10_standalone/sbeTest/testStartInstruction.py

        echo "*******************Run testAduMem_ecc.py*******************"

        run-python-file targets/p10_standalone/sbeTest/testAduMem_ecc.py

        echo "*******************Run testAduMem_itag.py*******************"

        run-python-file targets/p10_standalone/sbeTest/testAduMem_itag.py

        echo "*******************Run testAduMem_withEccItag.py*******************"

        run-python-file targets/p10_standalone/sbeTest/testAduMem_withEccItag.py

        echo "*******************Run testAduMem_noEccNoItag.py*******************"

        run-python-file targets/p10_standalone/sbeTest/testAduMem_noEccNoItag.py

        echo "*******************Run testAduMem_124B.py*******************"

        run-python-file targets/p10_standalone/sbeTest/testAduMem_124B.py

        echo "*******************Run testExitCacheContainedMode.py*******************"

        run-python-file targets/p10_standalone/sbeTest/testExitCacheContainedMode.py

        echo "*******************Run testHResetIpl.py*******************"

        run-python-file targets/p10_standalone/sbeTest/testHResetIpl.py

        echo "*******************Run testGetTIInfo.py*******************"

        run-python-file targets/p10_standalone/sbeTest/testGetTIInfo.py

        echo "*******************Run testFifoReset.py*******************"

        run-python-file targets/p10_standalone/sbeTest/testFifoReset.py

        # echo "*******************Run testEnterMpipl.py*******************"
        # TODO: As the changes enable the MPIPL flow , this will fail the CI
        # run-python-file targets/p10_standalone/sbeTest/testEnterMpipl.py

        echo "*******************Run testPutGetScom.py*******************"

        run-python-file targets/p10_standalone/sbeTest/testPutGetScom.py

        echo "*******************Run testUpdateOCMBTargets.py*******************"

        run-python-file targets/p10_standalone/sbeTest/testUpdateOCMBTargets.py

        echo "*******************Run testInvalidScom.py*******************"

        run-python-file targets/p10_standalone/sbeTest/testInvalidScom.py

        echo "*******************Run testPutGetHWReg.py*******************"

        run-python-file targets/p10_standalone/sbeTest/testPutGetHWReg.py

        echo "*******************Run testPSUGetHwReg.py****************"

        run-python-file targets/p10_standalone/sbeTest/testPSUGetHwReg.py


        echo "*******************Run testPSUSetFFDCAddr.py*******************"

        run-python-file targets/p10_standalone/sbeTest/testPSUSetFFDCAddr.py

        echo "*******************Run testPsuHostPassThrough.py*******************"

        run-python-file targets/p10_standalone/sbeTest/testPsuHostPassThrough.py


        # note after testQuesce the SBE will be in the quiesce state

        echo "*******************Run testQuiesce.py*******************"

        run-python-file targets/p10_standalone/sbeTest/testQuiesce.py

    }
}
#TODO: Remove exit
exit 0

echo "*******************Run testHostFFDC.py*******************"

run-python-file targets/p10_standalone/sbeTest/testHostFFDC.py

echo "*******************Run testPSUReadSbeMem.py*******************"

run-python-file targets/p10_standalone/sbeTest/testPSUReadSbeMem.py

echo "*******************Run testUnsecureMemRegions.py*******************"

run-python-file targets/p10_standalone/sbeTest/testUnsecureMemRegions.py

echo "*******************Run testMemPBA.py*******************"

run-python-file targets/p10_standalone/sbeTest/testMemPBA.py

echo "*******************Run testSram.py*******************"

run-python-file targets/p10_standalone/sbeTest/testSram.py

echo "*******************Run istep 5.2*******************"
sbe-istep 5 2

echo "*******************Run testSystemFabricMap.py*******************"

run-python-file targets/p10_standalone/sbeTest/testSystemFabricMap.py

echo "*******************Run testExecutorCntrlTimer.py*******************"

run-python-file targets/p10_standalone/sbeTest/testExecutorCntrlTimer.py

echo "*******************Run testExecutorStopTimer.py*******************"

run-python-file targets/p10_standalone/sbeTest/testExecutorStopTimer.py

echo "*******************Run testSecurity.py*******************"

run-python-file targets/p10_standalone/sbeTest/testSecurity.py

echo "*******************Run testStopClocks.py*******************"

run-python-file targets/p10_standalone/sbeTest/testStopClocks.py

echo "*******************Run testGetRing.py*******************"

run-python-file targets/p10_standalone/sbeTest/testGetRing.py

echo "*******************Run testExecutorPutRing.py*******************"

run-python-file targets/p10_standalone/sbeTest/testExecutorPutRing.py

echo "*******************Run testFastArray.py*******************"

run-python-file targets/p10_standalone/sbeTest/testFastArray.py

echo "*******************Run sbe-trace*******************"

sbe-trace 0
